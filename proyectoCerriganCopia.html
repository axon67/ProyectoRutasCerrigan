<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Buscador con Tabla</title>
  <style>
    :root { font-family: system-ui, Arial, sans-serif; }
    body { margin: 24px; }
    .wrap { max-width: 1200px; margin: 0 auto; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,.06); }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    input[type="text"], textarea { padding: 10px 12px; border-radius: 8px; border: 1px solid #cbd5e1; outline: none; }
    input[type="text"]:focus, textarea:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,.12); }
    button { padding: 6px 8px; border: 0; border-radius: 8px; cursor: pointer; margin: 1px }
    .btn { background: #3b82f6; color: white; }
    .btn-secondary { background: #0ea5e9; color: white; }
    .muted { color: #6b7280; }
    table { width: 100%; border-collapse: collapse; text-align: center; }
    th, td { text-align: center; vertical-align: middle; padding: 8px; }
    th { background: #f8fafc; }
    .highlight { background: #fff7cc; }
    .empty { padding: 16px; text-align: center; color: #6b7280; }
    a { color: #2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }
    /* Modal Imagen */
    #modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:1000; }
    #modalContent { position:relative; background:#fff; padding:16px; border-radius:12px; 
      max-width:90%; max-height:90%; }
    #modalImg { max-width:100%; max-height:80vh; display:block; margin:auto; border-radius:8px; }
    #cerrarModal {  position:absolute; top:8px; right:12px; cursor:pointer; font-size:22px; font-weight:bold; color:#555; background:none; border:none; }
    /* Modal Direcci√≥n */
    #modalDireccion { display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:1000; }
    #modalDireccionContent { background:#fff; padding:16px; border-radius:12px; max-width:600px; width:92%; position:relative; }
    #cerrarModalDireccion { position:absolute; top:8px; right:12px; cursor:pointer; font-size:20px; background:none; border:none; }
    #detalleDireccion { margin-top: 12px; font-size: 16px; color: #374151; white-space: pre-line; }
    .small-input { width: 180px; }
    textarea { width:100%; resize:vertical; min-height:64px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Buscador</h1>

    <!-- üîç BUSCADOR -->
    <div class="card" style="margin-bottom:16px">
      <div class="row">
        <input id="buscador" type="text" placeholder="Escribe para buscar..." autofocus />
        <button id="btnLimpiar" class="btn-secondary" title="Limpiar">Limpiar</button>
        <button id="btnToggleForm" class="btn">‚ûï Mostrar/Ocultar Formulario</button>
      </div>
      <p class="muted" style="margin:8px 0 0">Mostrando resultados para: <strong id="queryDisplay">‚Äî</strong></p>
    </div>

    <!-- ‚ûï FORMULARIO -->
    <div id="formularioCard" class="card" style="margin-bottom:16px; display:none;">
      <h2 style="margin-top:0">Agregar / Editar datos</h2>
      <div class="row" style="align-items:flex-start;">
        <input id="nuevoEmpresa" type="text" placeholder="Empresa / Lugar" class="small-input" />
        <input id="nuevaDireccion" type="text" placeholder="Direcci√≥n corta" class="small-input" />
        <input id="nuevoDistrito" type="text" placeholder="Distrito" class="small-input" />
        <input id="nuevoTelefono" type="text" placeholder="Tel√©fono" class="small-input" />
        <input id="nuevaCategoria" type="text" placeholder="Categor√≠a" class="small-input" />
        <input id="nuevoHorario" type="text" placeholder="Horario de atenci√≥n" class="small-input" />
        <input id="nuevoLink" type="text" placeholder="Link de Google Maps" style="flex:1 1 100%;" />
        <input id="nuevaImagen" type="text" placeholder="URL de la imagen" style="flex:1 1 100%;" />
        <textarea id="nuevoDetalleDireccion" placeholder="Detalle de la direcci√≥n (enter funciona)"></textarea>
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="btnAgregar" class="btn">Agregar / Guardar</button>
          <button id="btnBorrar" class="btn-secondary" title="Borrar todo">üóëÔ∏è Borrar todo</button>
        </div>
      </div>
    </div>

    <!-- üìã RESULTADOS -->
    <div class="card">
      <div class="row" style="justify-content: space-between; margin-bottom: 8px;">
        <h2 style="margin:0">Resultados</h2>
        <span class="muted" id="conteo">0 items</span>
      </div>
      <div style="overflow:auto">
        <table id="tabla">
          <thead>
            <tr>
              <th>ID</th>
              <th>Empresa</th>
              <th>Distrito</th>
              <th>Direcci√≥n</th>
              <th>Ubicaci√≥n</th>
              <th>Categor√≠a</th>
              <th>Horario</th>
              <th>Tel√©fono</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div id="vacio" class="empty" style="display:none">Sin resultados</div>
    </div>
  </div>

  <!-- Modal Imagen -->
  <div id="modal">
    <div id="modalContent">
      <button id="cerrarModal">‚úñ</button>
      <img id="modalImg" src="" alt="Vista">
    </div>
  </div>

  <!-- Modal Direcci√≥n -->
  <div id="modalDireccion">
    <div id="modalDireccionContent">
      <button id="cerrarModalDireccion">‚úñ</button>
      <h3>Detalle de Direcci√≥n</h3>
      <p id="detalleDireccion"></p>
    </div>
  </div>

  <script>
  const STORAGE_KEY = "misDatos";

  const BASE_DATOS = [
    { id: 1, empresa: "CBC peruana", direccion: "Huachipa", detalleDireccion: "Los Laureles 127, Lurigancho-Chosica 15457", distrito: "Este Lurigancho", telefono: "990297533", categoria: "Entrega", link: "https://maps.app.goo.gl/YBjWY1vPtzsbBUP76", imagen: "https://github.com/axon67/ProyectoRutasCerrigan/blob/main/Img/cbcPeruana.png?raw=true", horario: "3pm" },
    { id: 2, empresa: "Resemin S.A", direccion: "Urb Inds Sta Rosa", detalleDireccion: "Luis Galvani 392, Lima 15022", distrito: "Este Ate", telefono: "987654321", categoria: "Entrega", link: "https://maps.app.goo.gl/KRvQv7YVbn7MX8mLA", imagen: "https://github.com/axon67/ProyectoRutasCerrigan/blob/main/Img/reseminAte.png?raw=true", horario: "Lun-Sab 9am-5pm" },
    { id: 3, empresa: "Caliza inka", direccion: "Huachipa", detalleDireccion: "Sub Lote, Av. Cajamarquilla 2C, Lurigancho-Chosica", distrito: "Este Lurigancho", telefono: "-", categoria: "Empresa", link: "https://maps.app.goo.gl/XX6wbq553ud4aNWc6", imagen: "-", horario: "3pm" },
    { id: 4, empresa: "Resemin Priale", direccion: "Huachipa", detalleDireccion: "Av. Huachipa 215, Lima 15457", distrito: "Este Lurigancho", telefono: "-", categoria: "Entrega", link: "https://maps.app.goo.gl/HV4WRc8MiC3iArb3A", imagen: "-", horario: "3pm" }
  ];

  let datos = [...BASE_DATOS, ...(JSON.parse(localStorage.getItem(STORAGE_KEY)) || [])];
  let filtro = "";
  let editandoId = null;

  const el = id => document.getElementById(id);

  function normalizarTexto(t) {
    return (t ?? "").toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
  }

  function coincideRegistro(reg, needle) {
    if (!needle) return true;
    const n = normalizarTexto(needle);
    return [reg.id, reg.empresa, reg.direccion, reg.detalleDireccion, reg.distrito, reg.telefono, reg.categoria, reg.horario]
      .map(v => normalizarTexto(v))
      .some(v => v.includes(n));
  }

  // Para texto plano (retorna HTML seguro con <span>)
  function resaltarCoincidencias(texto, needle) {
    if (!needle) return String(texto);
    const t = String(texto);
    const n = normalizarTexto(needle);
    const base = normalizarTexto(t);
    let res = "", i = 0;
    while (i < t.length) {
      if (base.slice(i).startsWith(n)) {
        res += `<span class="highlight">${t.slice(i, i + needle.length)}</span>`;
        i += needle.length;
      } else { res += t[i]; i++; }
    }
    return res;
  }

  // Para enlaces/nodos: construye nodos sin romper atributos ni eventos
  function resaltarCoincidenciasNodo(elemento, texto, needle) {
    elemento.innerHTML = "";
    if (!needle) { elemento.textContent = texto; return; }
    const base = normalizarTexto(texto);
    const n = normalizarTexto(needle);
    let i = 0;
    while (i < texto.length) {
      if (base.slice(i).startsWith(n)) {
        const span = document.createElement("span");
        span.className = "highlight";
        span.textContent = texto.slice(i, i + needle.length);
        elemento.appendChild(span);
        i += needle.length;
      } else {
        elemento.appendChild(document.createTextNode(texto[i]));
        i++;
      }
    }
  }

  function guardarDatos() {
    const extras = datos.filter(d => d.id > BASE_DATOS.length);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(extras));
  }

  function render() {
    const cuerpo = el("tbody"), vacio = el("vacio"), conteo = el("conteo"), queryDisplay = el("queryDisplay");
    const filtrados = datos.filter(d => coincideRegistro(d, filtro));
    conteo.textContent = `${filtrados.length} ${filtrados.length === 1 ? "item" : "items"}`;
    queryDisplay.textContent = filtro ? `"${filtro}"` : "‚Äî";
    cuerpo.innerHTML = "";
    if (filtrados.length === 0) { vacio.style.display = "block"; return; } else { vacio.style.display = "none"; }

    const frag = document.createDocumentFragment();
    filtrados.forEach(reg => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${reg.id}</td>
        <td><a href="#" class="empresaLink" data-img="${reg.imagen}" aria-label="Empresa ${reg.empresa}"></a></td>
        <td class="td-distrito"></td>
        <td><a href="#" class="direccionLink" data-dir="${reg.detalleDireccion}" aria-label="Direcci√≥n ${reg.direccion}"></a></td>
        <td><a href="${reg.link}" target="_blank" rel="noopener noreferrer">Ver en Maps</a></td>
        <td class="td-categoria"></td>
        <td class="td-horario"></td>
        <td class="td-telefono"></td>
        <td>
          <button class="btn-secondary btnEditar" data-id="${reg.id}">‚úèÔ∏è</button>
          <button class="btn btnEliminar" data-id="${reg.id}">üóëÔ∏è</button>
        </td>
      `;

      // Resaltar en nodos <a> (sin romper atributos)
      const linkEmpresa = tr.querySelector(".empresaLink");
      resaltarCoincidenciasNodo(linkEmpresa, reg.empresa, filtro);

      const linkDireccion = tr.querySelector(".direccionLink");
      resaltarCoincidenciasNodo(linkDireccion, reg.direccion, filtro);

      // Resaltar en celdas de texto (se usa innerHTML intencionadamente para spans)
      tr.querySelector(".td-distrito").innerHTML = resaltarCoincidencias(reg.distrito, filtro);
      tr.querySelector(".td-categoria").innerHTML = resaltarCoincidencias(reg.categoria, filtro);
      tr.querySelector(".td-horario").innerHTML = resaltarCoincidencias(reg.horario ?? "‚Äî", filtro);
      tr.querySelector(".td-telefono").innerHTML = resaltarCoincidencias(reg.telefono, filtro);

      frag.appendChild(tr);
    });
    cuerpo.appendChild(frag);
  }

  // Eventos b√°sicos UI
  el("buscador").addEventListener("input", e => { filtro = e.target.value.trim(); render(); });
  el("btnLimpiar").addEventListener("click", () => { filtro = ""; el("buscador").value = ""; render(); el("buscador").focus(); });

  el("btnToggleForm").addEventListener("click", () => {
    const formCard = el("formularioCard");
    formCard.style.display = formCard.style.display === "none" ? "block" : "none";
  });

  // A√±adir / Guardar
  el("btnAgregar").addEventListener("click", () => {
    const empresa = el("nuevoEmpresa").value.trim();
    const direccion = el("nuevaDireccion").value.trim();
    const detalleDireccion = el("nuevoDetalleDireccion").value.trim();
    const distrito = el("nuevoDistrito").value.trim();
    const telefono = el("nuevoTelefono").value.trim();
    const categoria = el("nuevaCategoria").value.trim();
    const link = el("nuevoLink").value.trim();
    const imagen = el("nuevaImagen").value.trim();
    const horario = el("nuevoHorario").value.trim();

    if (!empresa || !direccion || !detalleDireccion || !distrito || !telefono || !categoria || !link || !imagen || !horario) {
      alert("Completa todos los campos.");
      return;
    }

    if (editandoId) {
      const idx = datos.findIndex(d => d.id === editandoId);
      if (idx >= 0) {
        datos[idx] = { id: editandoId, empresa, direccion, detalleDireccion, distrito, telefono, categoria, link, imagen, horario };
      }
      editandoId = null;
    } else {
      const nextId = (datos.at(-1)?.id ?? 0) + 1;
      datos.push({ id: nextId, empresa, direccion, detalleDireccion, distrito, telefono, categoria, link, imagen, horario });
    }

    guardarDatos();

    // limpiar form
    ["nuevoEmpresa","nuevaDireccion","nuevoDetalleDireccion","nuevoDistrito","nuevoTelefono","nuevaCategoria","nuevoLink","nuevaImagen","nuevoHorario"].forEach(id => el(id).value = "");
    el("formularioCard").style.display = "none";
    render();
  });

  // Borrar todos (solo extras)
  el("btnBorrar").addEventListener("click", () => {
    if (!confirm("¬øSeguro que quieres borrar todos los registros agregados?")) return;
    datos = [...BASE_DATOS];
    localStorage.removeItem(STORAGE_KEY);
    render();
  });

  // Delegaci√≥n de clics para acciones de fila y enlaces
  document.addEventListener("click", e => {
    // Editar
    const btnE = e.target.closest(".btnEditar");
    if (btnE) {
      const id = Number(btnE.dataset.id);
      const registro = datos.find(d => d.id === id);
      if (!registro) return;
      // llenar form
      el("nuevoEmpresa").value = registro.empresa;
      el("nuevaDireccion").value = registro.direccion;
      el("nuevoDetalleDireccion").value = registro.detalleDireccion;
      el("nuevoDistrito").value = registro.distrito;
      el("nuevoTelefono").value = registro.telefono;
      el("nuevaCategoria").value = registro.categoria;
      el("nuevoLink").value = registro.link;
      el("nuevaImagen").value = registro.imagen;
      el("nuevoHorario").value = registro.horario ?? "";
      editandoId = id;
      el("formularioCard").style.display = "block";
      el("nuevoEmpresa").focus();
      return;
    }

    // Eliminar
    const btnDel = e.target.closest(".btnEliminar");
    if (btnDel) {
      const id = Number(btnDel.dataset.id);
      if (id <= BASE_DATOS.length) {
        alert("No puedes eliminar un dato base.");
        return;
      }
      if (!confirm("¬øSeguro que quieres eliminar este registro?")) return;
      datos = datos.filter(d => d.id !== id);
      guardarDatos();
      render();
      return;
    }

    // Modal imagen (empresa)
    const linkEmpresa = e.target.closest(".empresaLink");
    if (linkEmpresa) {
      e.preventDefault();
      const img = linkEmpresa.dataset.img;
      el("modalImg").src = img || "";
      el("modal").style.display = "flex";
      return;
    }

    // Modal direcci√≥n
    const linkDireccion = e.target.closest(".direccionLink");
    if (linkDireccion) {
      e.preventDefault();
      const detalle = linkDireccion.dataset.dir;
      el("detalleDireccion").textContent = detalle || "";
      el("modalDireccion").style.display = "flex";
      return;
    }
  });

  // Cerrar modales
  el("cerrarModal").addEventListener("click", () => { el("modal").style.display = "none"; });
  el("cerrarModalDireccion").addEventListener("click", () => { el("modalDireccion").style.display = "none"; });

  // Cerrar modal al hacer click fuera del contenido (opcional y √∫til)
  window.addEventListener("click", (e) => {
    if (e.target === el("modal")) el("modal").style.display = "none";
    if (e.target === el("modalDireccion")) el("modalDireccion").style.display = "none";
  });

  // inicializar
  render();
  </script>
</body>
</html>
